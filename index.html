<!DOCTYPE html>
<meta charset="utf-8" />
<title>San Francisco Crime & Real Estate</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
<style>
body {
    padding: 0;
    margin: 0;
}
html, body, .container-fluid, .col-md-6, .row, #map, #detail {
    height: 100%;
}
.col-md-6 {
    padding: 0;
}
#detail {
    padding: 0 15px;
    overflow: auto;
}
.neighborhood {
    stroke: #003262;
    stroke-width: 1px;
    fill: #C2B9A7;
    fill-opacity: 0.4;
}
.selected-neighborhood {
    stroke: #00FF00;
    stroke-width: 2px;
    fill: #00FF00;
    fill-opacity: 0.6;
}
.neighborhood-label {
    fill: #53626F;
    fill-opacity: .8;
    text-anchor: middle;
}
</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="d3pie.min.js"></script>
<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6">
            <div id="map"></div>
        </div>
        <div class="col-md-6">
            <div id="detail">
                <div class="page-header">
                    <h1>San Francisco Crime & Real Estate</h1>
                </div>
                <div id="content">
                    <p>Click on a neighborhood to see its details!</p>
                </div>
                <hr />
                <p>See source at <a href="https://github.com/kennydo/datascience-hanzai-keisu">GitHub</a>.</p>
            </div>
        </div>
    </div>
</div>
<script>
function capitalize_category(category){
    return category.replace(/([A-Z])([A-Z]+)/g, function(match, p1, p2){ return p1 + p2.toLowerCase(); });
}

/*
 * Overlaying SVG on Leaflet based on http://bost.ocks.org/mike/leaflet/
 */
var map = L.map('map').setView([37.7593, -122.43710], 12);

L.tileLayer('http://otile1.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg', {
    attribution: 'Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png">'
}).addTo(map);

var svg = d3.select(map.getPanes().overlayPane).append("svg");
var g = svg.append("g").attr("class", "leaflet-zoom-hide");

d3.json("sf-neighborhoods.json", function(neighborhoods) {
    var transform = d3.geo.transform({point: projectPoint});
    var path = d3.geo.path().projection(transform);

    var feature = g.selectAll("path")
        .data(neighborhoods.features)
        .enter()
        .append("path")
        .attr("class", "neighborhood")
        .attr("name", function(d) {
            return d.properties.NAME;
        });

    var label = g.selectAll(".neighborhood-label")
        .data(neighborhoods.features)
        .enter()
        .append("text")
        .attr("class", "neighborhood-label")
        .text(function(d) {
            return d.properties.NAME;
        });

    map.on("viewreset", reset);
    reset();

    // Reposition the SVG to cover the features.
    function reset() {
        var bounds = path.bounds(neighborhoods);
        var topLeft = bounds[0];
        var bottomRight = bounds[1];

        svg.attr("width", bottomRight[0] - topLeft[0])
           .attr("height", bottomRight[1] - topLeft[1])
           .style("left", topLeft[0] + "px")
           .style("top", topLeft[1] + "px");

        g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

        feature.attr("d", path);
        label.attr("transform", function(d) {
            return "translate(" + path.centroid(d) + ")";
        })
        .style("font-size", (bottomRight[0] - topLeft[0]) * 0.018 + "px");
    }

    // Use Leaflet to implement a D3 geometric transformation.
    function projectPoint(x, y) {
        var point = map.latLngToLayerPoint(new L.LatLng(y, x));
        this.stream.point(point.x, point.y);
    }

    var prev_selected_neighborhood_index = -1;
    d3.json("sf-incidents.json", function(incidents) {
        console.log("Loaded incidents");
        feature
            .on("click", function(f, i) {
                var neighborhood_name = f["properties"]["NAME"];
                var neighborhood_data = incidents[neighborhood_name];
                var incident_counts = neighborhood_data["incident_counts"];

                if (prev_selected_neighborhood_index != -1){
                    feature.filter(function(d, j){ return j == prev_selected_neighborhood_index; })
                        .attr("class", "neighborhood");
                }
                feature.filter(function(d, j){ return j == i; })
                    .attr("class", "neighborhood selected-neighborhood");
                console.log("Clicked neighborhood: " + neighborhood_name + ", " + i);

                // update the detail pane
                var detail_content = $("#detail #content");
                $("#detail .page-header h1").text(neighborhood_name + " Neighborhood");
                var population = Number(neighborhood_data["population"]);
                detail_content.html("<p>Population: " + population.toLocaleString('en') + "</p>"
                                    + "<div id=\"piechart\"></div>");

                var pie_content = [];
                for(var category in incident_counts){
                    pie_content.push({
                        "label": capitalize_category(category),
                        "value": incident_counts[category]
                    });
                }
                var pie = new d3pie("piechart", {
                    "data": {
                        "sortOrder": "value-desc",
                        "content": pie_content
                    },
                    "labels": {
                        "outer": {
                            "format": "label-value2"
                        },
                        "inner": {
                            "hideWhenLessThanPercentage": 4
                        }
                    },
                    "effects": {
                        "load": {
                            "effect": "none"
                        }
                    }
                });

                prev_selected_neighborhood_index = i;
            });
    });
});
</script>
